<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vimśottarī Daśā — Hierarchy (Transit)</title>
<style>
  :root{
    --bg:#fbfaf6;
    --card:#ffffff;
    --muted:#666;
    --accent:#5a4328;
    --accent-2:#b57c3c;
    --success:#1a7f37;
    --danger:#b02a2a;
    font-family: "Segoe UI", Roboto, "Noto Sans", sans-serif;
  }
  body{ margin:0; background:linear-gradient(180deg,var(--bg),#f6f2ea); color:#222; padding:20px; }
  .container{ max-width:1100px; margin:0 auto; }
  header{ display:flex; align-items:center; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
  header h1{ margin:0; font-size:20px; color:var(--accent); }
  .card{ background:var(--card); border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(30,30,30,0.06); margin-bottom:14px; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  label{ font-size:13px; color:var(--muted); }
  .form-row { display:flex; gap:12px; align-items:center; }
  .form-group { display:flex; gap:8px; align-items:center; }
  input[type="number"], input[type="date"], input[type="time"], select {
    padding:8px 10px; border-radius:8px; border:1px solid #e5dcd0; box-sizing:border-box; font-size:14px;
  }
  #baseDate, #transitDate {
    width: 129px;
  }
  #baseTime, #transitTime {
    width: 99px;
  }
  #lagnaSelect, #rashiSelect {
    width: 90px;
  }
  #degInput {
    width: 80px;
  }
  .small{ font-size:13px; color:var(--muted); }
  .meta { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:8px; }
  .tree { margin-top:12px; }
  .maha-item, .bhukti-item, .antara-item, .sook-item {
    border-radius:8px; padding:8px 10px; margin-bottom:8px; background:linear-gradient(90deg, rgba(181,124,60,0.02), rgba(107,79,47,0.01));
  }
  .row-title { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .planet-Ketu { color: #8B4513; }
  .planet-Shukra { color: #a83157; }
  .planet-Surya { color: #FF5722; }
  .planet-Chandra { color: #5c09c9; }
  .planet-Mangal { color: #F44336; }
  .planet-Rahu { color: #4e4e4d; }
  .planet-Guru { color: #FFC107; }
  .planet-Shani { color: #03A9F4; }
  .planet-Budha { color: #4CAF50; }
  .node-left { display:flex; gap:10px; align-items:center; }
  .node-right { display:flex; gap:8px; align-items:center; }

  .highlight { box-shadow:0 0 0 3px rgba(26,127,55,0.06); background: linear-gradient(90deg, rgba(26,127,55,0.04), rgba(26,127,55,0.01)); }
  .active-crumb { color:var(--success); font-weight:700; }
  .date { font-size:13px; color:#444; }
  ul { margin:6px 0 0 16px; padding:0; list-style:none; }
  li { margin-bottom:6px; }
  .summary { padding:10px; border-radius:8px; background:#fbfbfb; border:1px solid #eee; margin-top:8px; }
  footer{ margin-top:12px; font-size:13px; color:var(--muted); }
  @media (max-width:820px){
    .row { flex-direction:column; align-items:flex-start; }
    input, select { width:100%; }
    .meta { flex-direction:column; align-items:flex-start; gap:6px; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>VIMSHOTHARI DASHA</h1>
    <div class="small">Enter Rāśi + degree (0–30) and a DOB/time. Use Transit date/time to see active daśā highlighted.</div>
  </header>

  <div class="card">
    <div class="form-row">
      <div class="form-group">
        <label for="baseDate">Base Date</label>
        <input id="baseDate" type="date" />
      </div>
      <div class="form-group">
        <label for="baseTime">Time</label>
        <input id="baseTime" type="time" step="60" />
      </div>
      <div class="form-group">
        <label for="lagnaSelect">Lagna</label>
        <select id="lagnaSelect">
          <option value="0">Mesha</option>
          <option value="1">Vrishabha</option>
          <option value="2">Mithuna</option>
          <option value="3">Karka</option>
          <option value="4">Simha</option>
          <option value="5">Kanya</option>
          <option value="6">Tula</option>
          <option value="7">Vrischika</option>
          <option value="8">Dhanu</option>
          <option value="9">Makara</option>
          <option value="10">Kumbha</option>
          <option value="11">Meena</option>
        </select>
      </div>
      <div class="form-group">
        <label for="rashiSelect">Rāśi</label>
        <select id="rashiSelect">
          <option value="0">Mesha</option>
          <option value="1">Vrishabha</option>
          <option value="2">Mithuna</option>
          <option value="3">Karka</option>
          <option value="4">Simha</option>
          <option value="5">Kanya</option>
          <option value="6">Tula</option>
          <option value="7">Vrischika</option>
          <option value="8">Dhanu</option>
          <option value="9">Makara</option>
          <option value="10">Kumbha</option>
          <option value="11">Meena</option>
        </select>
      </div>
      <div class="form-group">
        <label for="degInput">Moon Longitude</label>
        <input id="degInput" type="number" min="0" max="30" step="0.0001" value="0.0000" />
      </div>
      <div class="form-group">
        <label for="transitDate">Transit Date</label>
        <input id="transitDate" type="date" />
      </div>
      <div class="form-group">
        <label for="transitTime">Time</label>
        <input id="transitTime" type="time" step="60" />
      </div>
    </div>
    <div class="meta">
      <div class="small">Change any field and tree updates automatically (lazy expansion for deeper levels).</div>
      <div id="computedLom" class="small"></div>
    </div>
  </div>

  <div id="summaryCard" class="card">
    <div class="summary">
      <div><strong>Current Active Daśā (based on Transit Date)</strong></div>
      <div id="activeSummary" style="margin-top:6px;">—</div>
      <div id="activeBreadcrumb" style="margin-top:6px;color:var(--muted)"></div>
    </div>
  </div>

  <div id="treeCard" class="card">
    <div><strong>Mahā Daśā (click to expand Bhukti → Antara → Sūkṣma)</strong></div>
    <div id="treeContainer" class="tree"></div>
  </div>

  <footer>
    Tip: Transit date highlights the active chain. Start/end shown in dd-mm-yyyy. If you want start/end as Julian Date numbers as well, tell me and I will add them.
  </footer>
</div>

<script>
/* Port of Vimsottari logic from Swift to JS, with lazy expansion for tree UI.
   Constants & helpers similar to previous version. */

// Planet & sequence
const adhipati_sequence = ["Ketu","Shukra","Surya","Chandra","Mangal","Rahu","Guru","Shani","Budha"];
const mahadasha = { "Ketu":7,"Shukra":20,"Surya":6,"Chandra":10,"Mangal":7,"Rahu":18,"Guru":16,"Shani":19,"Budha":17 };
const vimsottari_year = 360.0;
const one_star = 360.0/27.0;

const rashiSelect = document.getElementById("rashiSelect");
const lagnaSelect = document.getElementById("lagnaSelect");
const degInput = document.getElementById("degInput");
const baseDate = document.getElementById("baseDate");
const baseTime = document.getElementById("baseTime");
const transitDate = document.getElementById("transitDate");
const transitTime = document.getElementById("transitTime");
const computedLomDiv = document.getElementById("computedLom");
const treeContainer = document.getElementById("treeContainer");
const activeSummary = document.getElementById("activeSummary");
const activeBreadcrumb = document.getElementById("activeBreadcrumb");

const lordShipData = {
  "Mesha": { "Surya": [5], "Chandra": [4], "Mangal": [1, 8], "Budha": [3, 6], "Guru": [9, 12], "Shukra": [2, 7], "Shani": [10, 11] },
  "Vrishabha": { "Surya": [4], "Chandra": [3], "Mangal": [7, 12], "Budha": [2, 5], "Guru": [8, 11], "Shukra": [1, 6], "Shani": [9, 10] },
  "Mithuna": { "Surya": [3], "Chandra": [2], "Mangal": [6, 11], "Budha": [1, 4], "Guru": [7, 10], "Shukra": [5, 12], "Shani": [8, 9] },
  "Karka": { "Surya": [2], "Chandra": [1], "Mangal": [5, 10], "Budha": [3, 12], "Guru": [6, 9], "Shukra": [4, 11], "Shani": [7, 8] },
  "Simha": { "Surya": [1], "Chandra": [12], "Mangal": [4, 9], "Budha": [2, 11], "Guru": [5, 8], "Shukra": [3, 10], "Shani": [6, 7] },
  "Kanya": { "Surya": [12], "Chandra": [11], "Mangal": [3, 8], "Budha": [1, 10], "Guru": [4, 7], "Shukra": [2, 9], "Shani": [5, 6] },
  "Tula": { "Surya": [11], "Chandra": [10], "Mangal": [2, 7], "Budha": [9, 12], "Guru": [3, 6], "Shukra": [1, 8], "Shani": [4, 5] },
  "Vrischika": { "Surya": [10], "Chandra": [9], "Mangal": [1, 6], "Budha": [8, 11], "Guru": [2, 5], "Shukra": [7, 12], "Shani": [3, 4] },
  "Dhanu": { "Surya": [9], "Chandra": [8], "Mangal": [5, 12], "Budha": [7, 10], "Guru": [1, 4], "Shukra": [6, 11], "Shani": [2, 3] },
  "Makara": { "Surya": [8], "Chandra": [7], "Mangal": [4, 11], "Budha": [6, 9], "Guru": [3, 12], "Shukra": [5, 10], "Shani": [1, 2] },
  "Kumbha": { "Surya": [7], "Chandra": [6], "Mangal": [3, 10], "Budha": [5, 8], "Guru": [2, 11], "Shukra": [4, 9], "Shani": [1, 12] },
  "Meena": { "Surya": [6], "Chandra": [5], "Mangal": [2, 9], "Budha": [4, 7], "Guru": [1, 10], "Shukra": [3, 8], "Shani": [11, 12] }
};
const rashiNames = ["Mesha", "Vrishabha", "Mithuna", "Karka", "Simha", "Kanya", "Tula", "Vrischika", "Dhanu", "Makara", "Kumbha", "Meena"];

// Utility: compute JD from Date object (uses UTC fields)
function dateToJD(dateObj) {
  // dateObj is JS Date
  const Y = dateObj.getUTCFullYear();
  let M = dateObj.getUTCMonth() + 1;
  const D = dateObj.getUTCDate() + (dateObj.getUTCHours()/24) + (dateObj.getUTCMinutes()/1440) + (dateObj.getUTCSeconds()/86400) + (dateObj.getUTCMilliseconds()/86400000);
  let A = Math.floor(Y/100);
  let B = 2 - A + Math.floor(A/4);
  let year = Y, month = M;
  if (month <= 2) { year = Y - 1; month = M + 12; }
  const JD = Math.floor(365.25*(year+4716)) + Math.floor(30.6001*(month+1)) + D + B - 1524.5;
  return JD;
}

// Convert JD -> readable dd-mm-yyyy (use UTC)
function jdToDateString(jd) {
  // Convert JD to JS Date (approx) using algorithm
  const z = Math.floor(jd + 0.5);
  const f = (jd + 0.5) - z;
  let A = z;
  if (z >= 2299161) {
    const alpha = Math.floor((z - 1867216.25)/36524.25);
    A = z + 1 + alpha - Math.floor(alpha/4);
  }
  const B = A + 1524;
  const C = Math.floor((B - 122.1)/365.25);
  const D = Math.floor(365.25 * C);
  const E = Math.floor((B - D)/30.6001);
  const day = B - D - Math.floor(30.6001 * E) + f;
  let month = (E < 14) ? E - 1 : E - 13;
  let year = (month > 2) ? C - 4716 : C - 4715;
  const dayInt = Math.floor(day);
  // create UTC Date object from year, month, dayInt at 00:00 UTC for display
  // For simplicity display date portion only
  const dd = String(dayInt).padStart(2,'0');
  const mm = String(month).padStart(2,'0');
  const yyyy = String(year);
  return `${dd}-${mm}-${yyyy}`;
}

// Core: nakshatra position from full moon longitude (0..360)
function nakshatraPositionFromLom(lom) {
  const nak_decimal = lom / one_star;
  const nak = Math.floor(nak_decimal); // 0..26
  const traversed = lom - nak * one_star;
  return { nak, traversed };
}

// dasha start date based on lom and JD
function dashaStartDate(jd, lom) {
  const { nak, traversed } = nakshatraPositionFromLom(lom);
  const lord = adhipati_sequence[nak % adhipati_sequence.length];
  const period = mahadasha[lord];
  let period_elapsed = (traversed / one_star) * period; // years fraction
  period_elapsed = period_elapsed * vimsottari_year; // days
  const start_date = jd - period_elapsed;
  return { lord, start_date };
}

// build mahadashas sequentially (9)
function vimsottariMahaDasha(jd, lom) {
  let { lord, start_date } = dashaStartDate(jd, lom);
  const maha = [];
  for (let i=0;i<9;i++){
    const nextStart = start_date + mahadasha[lord] * vimsottari_year;
    maha.push({ lord, start: start_date, end: nextStart });
    start_date = nextStart;
    const idx = adhipati_sequence.indexOf(lord);
    lord = adhipati_sequence[(idx+1) % adhipati_sequence.length];
  }
  return maha;
}

// bhukti inside a given maha (9)
function vimsottariBhukti(maha_lord, maha_start) {
  let bhukti_lord = maha_lord;
  let bh_start = maha_start;
  const arr = [];
  for (let i=0;i<9;i++){
    const factor = (mahadasha[bhukti_lord] * mahadasha[maha_lord]) / 120.0;
    const next = bh_start + factor * vimsottari_year;
    arr.push({ lord: bhukti_lord, start: bh_start, end: next });
    bh_start = next;
    const idx = adhipati_sequence.indexOf(bhukti_lord);
    bhukti_lord = adhipati_sequence[(idx+1) % adhipati_sequence.length];
  }
  return arr;
}

// antara inside bhukti
function vimsottariAntara(maha_lord, bhukti_lord, bhukti_start) {
  let antara_lord = bhukti_lord;
  let a_start = bhukti_start;
  const arr = [];
  for (let i=0;i<9;i++){
    let factor = mahadasha[antara_lord] * (mahadasha[maha_lord]/120.0);
    factor *= (mahadasha[bhukti_lord]/120.0);
    const next = a_start + factor * vimsottari_year;
    arr.push({ lord: antara_lord, start: a_start, end: next });
    a_start = next;
    const idx = adhipati_sequence.indexOf(antara_lord);
    antara_lord = adhipati_sequence[(idx+1) % adhipati_sequence.length];
  }
  return arr;
}

// sookshma inside antara (we will compute lazily)
function vimsottariSookshma(maha_lord, bhukti_lord, antara_lord, antara_start) {
  let sook_lord = antara_lord;
  let s_start = antara_start;
  const arr = [];
  for (let i=0;i<9;i++){
    const factor = mahadasha[sook_lord] * (mahadasha[bhukti_lord]/120.0) * (mahadasha[antara_lord]/120.0) * (mahadasha[maha_lord]/120.0);
    const next = s_start + factor * vimsottari_year;
    arr.push({ lord: sook_lord, start: s_start, end: next });
    s_start = next;
    const idx = adhipati_sequence.indexOf(sook_lord);
    sook_lord = adhipati_sequence[(idx+1) % adhipati_sequence.length];
  }
  return arr;
}

// Helper to build full chain start from base inputs
function computeMahaList(jdBase, lom) {
  return vimsottariMahaDasha(jdBase, lom);
}

// UI helpers
function getInputs() {
  const rashiIndex = Number(rashiSelect.value);
  const lagnaIndex = Number(lagnaSelect.value);
  const degVal = Number(degInput.value) || 0;
  const lom = (rashiIndex * 30) + degVal; // 0..360
  // parse base date/time -> JS Date in local timezone
  const baseDateVal = baseDate.value;
  const baseTimeVal = baseTime.value || "00:00";
  const transitDateVal = transitDate.value;
  const transitTimeVal = transitTime.value || "00:00";
  const baseJs = parseLocalDateTime(baseDateVal, baseTimeVal);
  const transitJs = parseLocalDateTime(transitDateVal, transitTimeVal);
  const baseJD = dateToJD(baseJs);
  const transitJD = dateToJD(transitJs);
  return { lom, baseJD, transitJD, baseJs, transitJs, lagnaIndex };
}

function parseLocalDateTime(dateStr, timeStr) {
  // dateStr format "yyyy-mm-dd", timeStr "HH:MM"
  if (!dateStr) {
    // fallback to now
    return new Date();
  }
  const [y,m,d] = dateStr.split("-").map(s=>Number(s));
  const [hh,mm] = (timeStr||"00:00").split(":").map(s=>Number(s));
  // Build a Date in local timezone
  return new Date(y, m-1, d, hh, mm, 0, 0);
}

// format dd-mm-yyyy
function formatDDMMYYYY(jd) { return jdToDateString(jd); }

// Create tree (only MAHA at first). Use lazy expansion for children.
function renderTree() {
  treeContainer.innerHTML = "";
  const { lom, baseJD, transitJD, lagnaIndex } = getInputs();
  const lagnaName = rashiNames[lagnaIndex];
  const lordship = lordShipData[lagnaName];

  computedLomDiv.textContent = `Computed full Moon longitude (0–360°): ${lom.toFixed(4)}°`;
  const mahaList = computeMahaList(baseJD, lom);

  const activePath = findActivePath(mahaList, transitJD);

  mahaList.forEach((m, i) => {
    const mahaDiv = document.createElement("div");
    mahaDiv.className = "maha-item";
    if (activePath && activePath.mahaIndex === i) mahaDiv.classList.add("highlight");
    
    const left = document.createElement("div");
    left.className = "node-left";
    left.style.cursor = "pointer";
    left.dataset.expanded = "false";

    const lord = m.lord;
    const lords = lordship[lord] ? `(${lordship[lord].join(',')})` : '';
    const title = document.createElement("div");
    title.innerHTML = `<div style="font-weight:700"><span class="planet-${lord}">${lord}${lords}</span> (${formatDDMMYYYY(m.start)} to ${formatDDMMYYYY(m.end)})</div>`;
    left.appendChild(title);

    const bhuktiContainer = document.createElement("div");
    bhuktiContainer.style.marginTop = "8px";
    bhuktiContainer.style.display = "none";

    left.addEventListener("click", () => {
      const expanded = left.dataset.expanded === "true";
      if (expanded) {
        bhuktiContainer.style.display = "none";
        left.dataset.expanded = "false";
      } else {
        if (!bhuktiContainer.hasChildNodes()) {
          const bhuktis = vimsottariBhukti(m.lord, m.start);
          const ul = document.createElement("ul");
          bhuktis.forEach((b, bi) => {
            const li = document.createElement("li");
            const div = document.createElement("div");
            div.className = "bhukti-item";
            if (activePath && activePath.mahaIndex === i && activePath.bhuktiIndex === bi) div.classList.add("highlight");
            
            const bhuktiTitle = document.createElement("div");
            bhuktiTitle.className = "row-title";
            bhuktiTitle.style.cursor = "pointer";
            bhuktiTitle.dataset.expanded = "false";
            const bhuktiLord = b.lord;
            const bhuktiLords = lordship[bhuktiLord] ? `(${lordship[bhuktiLord].join(',')})` : '';
            bhuktiTitle.innerHTML = `<div class="node-left"><div style="font-weight:600"><span class="planet-${bhuktiLord}">${bhuktiLord}${bhuktiLords}</span> (${formatDDMMYYYY(b.start)} to ${formatDDMMYYYY(b.end)})</div></div>`;
            
            const antaraContainer = document.createElement("div");
            antaraContainer.style.marginTop = "8px";
            antaraContainer.style.display = "none";

            bhuktiTitle.addEventListener("click", (e) => {
              e.stopPropagation();
              const exp = bhuktiTitle.dataset.expanded === "true";
              if (exp) {
                antaraContainer.style.display = "none";
                bhuktiTitle.dataset.expanded = "false";
              } else {
                if (!antaraContainer.hasChildNodes()) {
                  const antaras = vimsottariAntara(m.lord, b.lord, b.start);
                  const ulA = document.createElement("ul");
                  antaras.forEach((a, ai) => {
                    const lia = document.createElement("li");
                    const diva = document.createElement("div");
                    diva.className = "antara-item";
                    if (activePath && activePath.mahaIndex === i && activePath.bhuktiIndex === bi && activePath.antaraIndex === ai) diva.classList.add("highlight");
                    
                    const antaraTitle = document.createElement("div");
                    antaraTitle.className = "row-title";
                    antaraTitle.style.cursor = "pointer";
                    antaraTitle.dataset.expanded = "false";
                    const antaraLord = a.lord;
                    const antaraLords = lordship[antaraLord] ? `(${lordship[antaraLord].join(',')})` : '';
                    antaraTitle.innerHTML = `<div class="node-left"><div style="font-weight:500"><span class="planet-${antaraLord}">${antaraLord}${antaraLords}</span> (${formatDDMMYYYY(a.start)} to ${formatDDMMYYYY(a.end)})</div></div>`;

                    const sookContainer = document.createElement("div");
                    sookContainer.style.marginTop = "8px";
                    sookContainer.style.display = "none";

                    antaraTitle.addEventListener("click", (e) => {
                      e.stopPropagation();
                      const ex = antaraTitle.dataset.expanded === "true";
                      if (ex) {
                        sookContainer.style.display = "none";
                        antaraTitle.dataset.expanded = "false";
                      } else {
                        if (!sookContainer.hasChildNodes()) {
                          const sooks = vimsottariSookshma(m.lord, b.lord, a.lord, a.start);
                          const ulS = document.createElement("ul");
                          sooks.forEach((s, si) => {
                            const lis = document.createElement("li");
                            const divs = document.createElement("div");
                            divs.className = "sook-item";
                            if (activePath && activePath.mahaIndex === i && activePath.bhuktiIndex === bi && activePath.antaraIndex === ai && activePath.sookIndex === si) divs.classList.add("highlight");
                            const sookLord = s.lord;
                            const sookLords = lordship[sookLord] ? `(${lordship[sookLord].join(',')})` : '';
                            divs.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                              <div><strong><span class="planet-${sookLord}">${sookLord}${sookLords}</span> (${formatDDMMYYYY(s.start)} to ${formatDDMMYYYY(s.end)})</strong></div>
                            </div>`;
                            lis.appendChild(divs);
                            ulS.appendChild(lis);
                          });
                          sookContainer.appendChild(ulS);
                        }
                        sookContainer.style.display = "block";
                        antaraTitle.dataset.expanded = "true";
                      }
                    });
                    diva.appendChild(antaraTitle);
                    diva.appendChild(sookContainer);
                    lia.appendChild(diva);
                    ulA.appendChild(lia);
                  });
                  antaraContainer.appendChild(ulA);
                }
                antaraContainer.style.display = "block";
                bhuktiTitle.dataset.expanded = "true";
              }
            });

            div.appendChild(bhuktiTitle);
            div.appendChild(antaraContainer);
            li.appendChild(div);
            ul.appendChild(li);
          });
          bhuktiContainer.appendChild(ul);
        }
        bhuktiContainer.style.display = "block";
        left.dataset.expanded = "true";
      }
    });

    mahaDiv.appendChild(left);
    mahaDiv.appendChild(bhuktiContainer);
    treeContainer.appendChild(mahaDiv);
  });

  // update active summary
  if (activePath && activePath.found) {
    const p = activePath;
    const mahaLord = p.maha;
    const bhuktiLord = p.bhukti;
    const antaraLord = p.antara;
    const sookLord = p.sook;

    const mahaLords = lordship[mahaLord] ? `(${lordship[mahaLord].join(',')})` : '';
    const bhuktiLords = lordship[bhuktiLord] ? `(${lordship[bhuktiLord].join(',')})` : '';
    const antaraLords = lordship[antaraLord] ? `(${lordship[antaraLord].join(',')})` : '';
    const sookLords = lordship[sookLord] ? `(${lordship[sookLord].join(',')})` : '';

    activeSummary.innerHTML = `<div>
        <strong><span class="planet-${mahaLord}">${mahaLord}${mahaLords}</span></strong> → 
        <strong><span class="planet-${bhuktiLord}">${bhuktiLord}${bhuktiLords}</span></strong> → 
        <strong><span class="planet-${antaraLord}">${antaraLord}${antaraLords}</span></strong> → 
        <strong><span class="planet-${sookLord}">${sookLord}${sookLords}</span></strong>
      </div>
      <div class="small">Start: ${formatDDMMYYYY(p.start)} • End: ${formatDDMMYYYY(p.end)}</div>`;
    
    activeBreadcrumb.innerHTML = `Active chain: 
      <span class="planet-${mahaLord}">${mahaLord}</span> &gt; 
      <span class="planet-${bhuktiLord}">${bhuktiLord}</span> &gt; 
      <span class="planet-${antaraLord}">${antaraLord}</span> &gt; 
      <span class="planet-${sookLord}">${sookLord}</span>`;
  } else {
    activeSummary.innerHTML = `<div class="small">No active sūkṣma found for the selected transit date (transit may be outside displayed 9-mahadasha window).</div>`;
    activeBreadcrumb.textContent = '';
  }
}

// Find the active deepest path for the given transitJD by scanning generated maha->bhukti->antara->sookshma ranges
// We only scan until we find containing sookshma; we don't generate all sookshmas for all mahadashas.
function findActivePath(mahaList, transitJD) {
  if (!transitJD || isNaN(transitJD)) return null;
  for (let mi=0; mi<mahaList.length; mi++) {
    const m = mahaList[mi];
    if (transitJD >= m.start && transitJD <= m.end) {
      // inside this maha, find bhukti
      const bhuktis = vimsottariBhukti(m.lord, m.start);
      for (let bi=0; bi<bhuktis.length; bi++) {
        const b = bhuktis[bi];
        if (transitJD >= b.start && transitJD <= b.end) {
          const antaras = vimsottariAntara(m.lord, b.lord, b.start);
          for (let ai=0; ai<antaras.length; ai++) {
            const a = antaras[ai];
            if (transitJD >= a.start && transitJD <= a.end) {
              const sooks = vimsottariSookshma(m.lord, b.lord, a.lord, a.start);
              for (let si=0; si<sooks.length; si++) {
                const s = sooks[si];
                if (transitJD >= s.start && transitJD <= s.end) {
                  return {
                    found: true,
                    mahaIndex: mi, bhuktiIndex: bi, antaraIndex: ai, sookIndex: si,
                    maha: m.lord, bhukti: b.lord, antara: a.lord, sook: s.lord,
                    start: s.start, end: s.end
                  };
                }
              }
              // inside antara but no sook matched
              return {
                found: false,
                mahaIndex: mi, bhuktiIndex: bi, antaraIndex: ai,
                maha: m.lord, bhukti: b.lord, antara: a.lord
              };
            }
          }
          // inside bhukti but no antara matched
          return { found:false, mahaIndex:mi, bhuktiIndex:bi, maha:m.lord, bhukti:b.lord };
        }
      }
      // inside maha but no bhukti matched
      return { found:false, mahaIndex:mi, maha: m.lord };
    }
  }
  // transit not in any of shown maha windows
  return null;
}

// Wire events to auto-update
function wireEvents() {
  [rashiSelect, lagnaSelect, degInput, baseDate, baseTime, transitDate, transitTime].forEach(el => {
    el.addEventListener("change", () => {
      renderTree();
    });
    el.addEventListener("input", () => {
      // real-time for degree changes
      renderTree();
    });
  });
}

// Initialize defaults (set base and transit date/time to system date/time)
function initDefaults() {
  const now = new Date();
  // local date string yyyy-mm-dd
  const pad = n => String(n).padStart(2,'0');
  const yyyy = now.getFullYear();
  const mm = pad(now.getMonth()+1);
  const dd = pad(now.getDate());
  const hh = pad(now.getHours());
  const mins = pad(now.getMinutes());
  baseDate.value = `${yyyy}-${mm}-${dd}`;
  baseTime.value = `${hh}:${mins}`;
  transitDate.value = `${yyyy}-${mm}-${dd}`;
  transitTime.value = `${hh}:${mins}`;
  // default rashi Mesha already set; degree default 0
}

// Kick off
initDefaults();
wireEvents();
renderTree();
</script>
</body>
</html>
